# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## About This Branch

**Branch:** `javascript-fork-v3` (with v3.1 on `javascript-fork-v3.1`)
**Version:** 3.1.0
**Architecture:** JavaScript-only (no Rust dependencies)

This is a JavaScript-only fork of Tailwind CSS v3, originally based on v3.0.24 - the last version before the Rust/Oxide engine was introduced. This branch has been upgraded with v3.1 features while maintaining the pure JavaScript/TypeScript architecture.

**Note:** The `main` branch contains v4 with Rust/pnpm/monorepo architecture. This document describes the `javascript-fork-v3.1` branch only.

### v3.1.0 Update

The v3.1.0 release includes key features from Tailwind CSS v3.1, adapted for JavaScript-only architecture:

**New Features:**
- ✅ Arbitrary variants (`[&:hover]:text-red-500`, `[&_p]:text-sm`)
- ✅ New utilities (`border-spacing-*`, `text-start/end`, `grid-flow-dense`, `mix-blend-plus-lighter`)
- ✅ New variants (`backdrop:`, `enabled:`, `optional:`, `contrast-more/less:`)

**Architecture Changes:**
- Enhanced `src/lib/generateRules.js` with arbitrary variant parsing and application
- Updated `src/lib/defaultExtractor.js` to extract arbitrary variant patterns
- Added new variant plugins in `src/corePlugins.js`
- All changes maintain JavaScript-only architecture (no Rust/Oxide dependencies)

## Commands

### Build and Development
```bash
# Install dependencies
npm install

# Build with version-specific folders (recommended)
npm run build

# Create version-specific tarball
npm run pack

# Build and package together
npm run build:pack

# Legacy build (outputs to lib/ without versioning)
npm run swcify

# Generate plugin list (run automatically by build)
npm run generate
```

### Testing
```bash
# Run all tests
npm test

# Run tests only (without linting)
npm run pretest && jest

# Run integration tests
npm run test:integrations

# Run specific test file
npx jest tests/[test-file].test.js
```

### Code Quality
```bash
# Check linting (ESLint + Prettier)
npm run style

# Auto-format code
npx prettier --write .
```

## Architecture

### Project Structure

This is a **single-package** JavaScript/TypeScript project (not a monorepo):

- **`src/`** - TypeScript/JavaScript source code
- **`lib/`** - Compiled output (generated by build process)
- **`scripts/`** - Build and utility scripts
- **`tests/`** - Jest test files
- **`integrations/`** - Integration test projects

### Core Components

**Main Entry Points:**
- **`src/index.js`** - Main library export, PostCSS plugin
- **`src/cli.js`** - Command-line interface
- **`src/processTailwindFeatures.js`** - Core processing pipeline

**Key Modules:**
- **`src/lib/generateRules.js`** - Utility and variant generation
- **`src/lib/setupContextUtils.js`** - Configuration and context management
- **`src/lib/expandTailwindAtRules.js`** - @tailwind directive processing
- **`src/lib/expandApplyAtRules.js`** - @apply directive processing
- **`src/corePlugins.js`** - Built-in utility definitions
- **`src/util/`** - Shared utility functions

**Public API:**
- **`src/public/colors.js`** - Color palette
- **`src/public/default-theme.js`** - Default theme configuration
- **`src/public/default-config.js`** - Default configuration
- **`src/public/resolve-config.js`** - Configuration resolution

### Version-Specific Build System

**Build Process:**
1. **Plugin generation** - Creates `src/corePluginList.js` from `src/corePlugins.js`
2. **SWC compilation** - Transpiles `src/` → `lib/VERSION/` (e.g., `lib/3.0.24/`)
3. **Peer bundling** - Bundles CLI peer dependencies with esbuild
4. **Symlink creation** - Creates `lib/*.js` symlinks → `lib/VERSION/*.js`

**Build Scripts:**
- **`scripts/build-versioned.js`** - Orchestrates versioned build
- **`scripts/pack-versioned.js`** - Creates versioned tarballs
- **`scripts/get-version.js`** - Extracts version from package.json
- **`scripts/create-plugin-list.js`** - Generates plugin list
- **`scripts/generate-types.js`** - Generates TypeScript definitions

**Output Structure:**
```
lib/
├── 3.0.24/              # Versioned build output
│   ├── index.js
│   ├── cli.js
│   ├── lib/
│   ├── css/
│   └── util/
├── index.js             # Symlink → 3.0.24/index.js
├── cli.js               # Symlink → 3.0.24/cli.js
└── ...                  # Other symlinks

dist/
├── 3.0.24/
│   └── tailwindcss-3.0.24.tgz
└── tailwindcss-3.0.24.tgz  # Copy for backwards compat

peers/
└── index.js             # Bundled peer dependencies
```

**Version Management:**
- Version is read from root `package.json`
- Each build creates/updates its version folder
- Old version folders are preserved
- Symlinks point to the most recent build
- Multiple versions can coexist

**Benefits:**
- Work on v3.0.24 while developing v3.1.0
- Test different versions side-by-side
- Install from specific version tarballs
- Backwards compatible via symlinks

### Build Tools

- **SWC** - Fast TypeScript/JavaScript transpiler
- **esbuild** - Bundles peer dependencies for CLI
- **Jest** - Testing framework with @swc/jest transformer
- **ESLint + Prettier** - Code quality and formatting

### Testing Strategy

- **Unit tests** - Co-located `.test.js` files in `tests/` using Jest
- **Integration tests** - Full build tool integration in `integrations/`
- **Test tools** - Various bundler integrations (Webpack, Parcel, Rollup, etc.)

### Key Architectural Concepts

**PostCSS Pipeline:**
1. User's CSS passes through PostCSS
2. Tailwind plugin processes `@tailwind` directives
3. Utilities are generated based on content scanning
4. `@apply` directives are expanded
5. Final CSS is optimized and output

**Content Scanning:**
- Uses `fast-glob` to find source files
- Extracts class name candidates via regex
- Generates only the CSS for used utilities

**Configuration System:**
- Loads `tailwind.config.js` from project root
- Merges with default configuration
- Supports theme customization and plugins
- Uses `lilconfig` for flexible config loading

**Plugin System:**
- Plugins register utilities, components, and base styles
- Use `addUtilities()`, `addComponents()`, `addBase()` APIs
- Can access theme values and variants
- Support for custom variants via `addVariant()`
